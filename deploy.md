# GitHub Actions è‡ªåŠ¨éƒ¨ç½²æŒ‡å—

> âœ… **å·²å®ç°åŠŸèƒ½**: æ¯æ¬¡ `git push` è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ

## ğŸ¯ å¿«é€Ÿå¼€å§‹

| æ­¥éª¤ | æ“ä½œ | æ‰§è¡Œæ¬¡æ•° |
|------|------|----------|
| **1** | æœ¬åœ°ç”Ÿæˆ SSH å¯†é’¥ | ä¸€æ¬¡ |
| **2** | æœåŠ¡å™¨è¿è¡Œä¸€é”®è„šæœ¬ | ä¸€æ¬¡ |
| **3** | GitHub æ·»åŠ  Secrets | ä¸€æ¬¡ |
| **4** | `git push` è‡ªåŠ¨éƒ¨ç½² | æ¯æ¬¡æäº¤ |

---

## ğŸ“‹ è¯¦ç»†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”Ÿæˆå¯†é’¥    â”‚â”€â”€â”€â”€â†’â”‚  2. æœåŠ¡å™¨åˆå§‹åŒ– â”‚â”€â”€â”€â”€â†’â”‚  3. è‡ªåŠ¨éƒ¨ç½²ï¼ˆå·²å®Œæˆï¼‰   â”‚
â”‚   (æœ¬åœ°æ‰§è¡Œ)    â”‚     â”‚  (æœåŠ¡å™¨æ‰§è¡Œä¸€æ¬¡) â”‚     â”‚  æ¯æ¬¡ git push è‡ªåŠ¨è§¦å‘  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ å‰ç½®è¦æ±‚

### 1. æœ¬åœ°ç”Ÿæˆ SSH å¯†é’¥å¯¹

GitHub Actions éœ€è¦ SSH è¿æ¥åˆ°æœåŠ¡å™¨æ‰§è¡Œéƒ¨ç½²å‘½ä»¤ï¼Œä½¿ç”¨å¯†é’¥å¯¹è¿›è¡Œèº«ä»½éªŒè¯ï¼š

```bash
ssh-keygen -t ed25519 -C "github-actions" -f ~/.ssh/github_actions
# ä¸€è·¯å›è½¦ï¼Œä¸è®¾ç½®å¯†ç 
```

ç”Ÿæˆä¸¤ä¸ªé…å¯¹çš„æ–‡ä»¶ï¼š

| æ–‡ä»¶ | å­˜æ”¾ä½ç½® | ä½œç”¨ |
|------|---------|------|
| `github_actions`ï¼ˆç§é’¥ï¼‰ | GitHub Secrets | GitHub Actions ç”¨å®ƒè¯æ˜"æˆ‘æ˜¯è°" |
| `github_actions.pub`ï¼ˆå…¬é’¥ï¼‰ | æœåŠ¡å™¨çš„ `~/.ssh/authorized_keys` | æœåŠ¡å™¨ç”¨å®ƒéªŒè¯"ä½ æ˜¯è°" |

**ç±»æ¯”**ï¼šç§é’¥æ˜¯é’¥åŒ™ï¼Œå…¬é’¥æ˜¯é”ã€‚GitHub Actions æ‹¿ç€é’¥åŒ™ï¼ˆç§é’¥ï¼‰ï¼ŒæœåŠ¡å™¨æ£€æŸ¥é’¥åŒ™æ˜¯å¦åŒ¹é…é”ï¼ˆå…¬é’¥ï¼‰ï¼ŒåŒ¹é…æ‰å…è®¸è¿›å…¥æ‰§è¡Œå‘½ä»¤ã€‚

### 2. æœåŠ¡å™¨ç«¯ä¸€é”®éƒ¨ç½²

**æ–¹å¼ä¸€ï¼šä½¿ç”¨ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰**

```bash
# 1. ä¸Šä¼ å…¬é’¥åˆ°æœåŠ¡å™¨
ssh-copy-id -i ~/.ssh/github_actions.pub root@ä½ çš„æœåŠ¡å™¨IP

# 2. ç™»å½•æœåŠ¡å™¨
ssh root@ä½ çš„æœåŠ¡å™¨IP

# 3. ä¸‹è½½éƒ¨ç½²è„šæœ¬ï¼ˆé¦–æ¬¡éƒ¨ç½²åå¯ç›´æ¥è¿è¡Œé¡¹ç›®ä¸­çš„è„šæœ¬ï¼‰
curl -fsSL -o deploy.sh https://raw.githubusercontent.com/ä½ çš„ç”¨æˆ·å/ä½ çš„ä»“åº“/main/deploy.sh
bash deploy.sh
```

> ğŸ’¡ **æç¤º**: è„šæœ¬è¿è¡Œåä¼šæç¤ºè¾“å…¥ Git ä»“åº“åœ°å€ï¼Œç„¶åè‡ªåŠ¨å®Œæˆæ‰€æœ‰é…ç½®ã€‚æ•°æ®åº“å’Œ `.env` é…ç½®ä¼šæœ‰äº¤äº’å¼æç¤ºã€‚

**æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²**

```bash
# 1. ä¸Šä¼ å…¬é’¥åˆ°æœåŠ¡å™¨
ssh-copy-id -i ~/.ssh/github_actions.pub root@ä½ çš„æœåŠ¡å™¨IP

# 2. ç™»å½•æœåŠ¡å™¨
ssh root@ä½ çš„æœåŠ¡å™¨IP

# 3. å®‰è£… Node.js 18+
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
apt-get install -y nodejs

# 4. å®‰è£… PM2
npm install -g pm2

# 5. å…‹éš†é¡¹ç›®
git clone https://github.com/ä½ çš„ç”¨æˆ·å/ä½ çš„ä»“åº“.git /var/www/back-master
cd /var/www/back-master

# 6. å®‰è£…ä¾èµ–
npm ci --production

# 7. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
nano .env

# 8. å¯åŠ¨
pm2 start ecosystem.config.js --env production
pm2 save
pm2 startup
```

### 3. é…ç½® GitHub Secrets

åœ¨ GitHub ä»“åº“é¡µé¢ï¼Œè¿›å…¥ **Settings â†’ Secrets and variables â†’ Actions**ï¼Œæ·»åŠ ä»¥ä¸‹ Secretsï¼š

| Secret åç§° | è¯´æ˜ | ç¤ºä¾‹ |
|------------|------|------|
| `SERVER_HOST` | æœåŠ¡å™¨ IP æˆ–åŸŸå | `192.168.1.100` |
| `SERVER_USER` | SSH ç™»å½•ç”¨æˆ·å | `root` æˆ– `ubuntu` |
| `SSH_PRIVATE_KEY` | SSH ç§é’¥å†…å®¹ | è§ä¸‹æ–¹ç”Ÿæˆæ–¹æ³• |
| `SERVER_PORT` | SSH ç«¯å£ï¼ˆå¯é€‰ï¼‰ | `22` |
| `DEPLOY_PATH` | é¡¹ç›®éƒ¨ç½²è·¯å¾„ | `/var/www/back-master` |



## ğŸš€ è‡ªåŠ¨éƒ¨ç½²ï¼ˆå·²å®Œæˆé…ç½®ï¼‰

### è§¦å‘æ¡ä»¶

é…ç½®å®Œæˆåï¼Œä»¥ä¸‹æ“ä½œä¼šè‡ªåŠ¨è§¦å‘éƒ¨ç½²ï¼š
| æ“ä½œ | è§¦å‘ç»“æœ |
|------|----------|
| `git push origin main` | âœ… è‡ªåŠ¨éƒ¨ç½² |
| PR åˆå¹¶åˆ° `main`/`master` | âœ… è‡ªåŠ¨éƒ¨ç½² |

### æœ¬åœ°å¼€å‘æµç¨‹

```bash
# 1. ä¿®æ”¹ä»£ç 
git add .
git commit -m "feat: æ–°å¢åŠŸèƒ½"

# 2. æ¨é€ä»£ç  â†’ è‡ªåŠ¨è§¦å‘éƒ¨ç½²
git push origin main

# 3. ç­‰å¾…çº¦ 30 ç§’ï¼Œéƒ¨ç½²å®Œæˆ
# å¯åœ¨ GitHub ä»“åº“ â†’ Actions æ ‡ç­¾é¡µæŸ¥çœ‹éƒ¨ç½²æ—¥å¿—
```

### GitHub Actions è‡ªåŠ¨æ‰§è¡Œçš„æ­¥éª¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub Actions è‡ªåŠ¨éƒ¨ç½²æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. æ£€å‡ºä»£ç                                              â”‚
â”‚  2. å®‰è£… Node.js ä¾èµ–ï¼ˆç”¨äºæµ‹è¯•ï¼Œå¯é€‰ï¼‰                   â”‚
â”‚  3. SSH è¿æ¥åˆ°æœåŠ¡å™¨                                      â”‚
â”‚  4. æ‰§è¡Œ git pull æ‹‰å–æœ€æ–°ä»£ç                             â”‚
â”‚  5. æ‰§è¡Œ npm ci --production å®‰è£…ç”Ÿäº§ä¾èµ–                 â”‚
â”‚  6. æ‰§è¡Œ pm2 reload å¹³æ»‘é‡å¯åº”ç”¨ï¼ˆé›¶åœæœºï¼‰                 â”‚
â”‚  7. ä¿å­˜ PM2 è¿›ç¨‹åˆ—è¡¨                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… éªŒè¯è‡ªåŠ¨éƒ¨ç½²

### æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€

1. **GitHub ä»“åº“** â†’ **Actions** æ ‡ç­¾é¡µ
2. ç‚¹å‡»æœ€æ–°çš„å·¥ä½œæµè¿è¡Œè®°å½•
3. æŸ¥çœ‹å®æ—¶æ—¥å¿—

### æŸ¥çœ‹åº”ç”¨çŠ¶æ€ï¼ˆæœåŠ¡å™¨ï¼‰

```bash
# æŸ¥çœ‹åº”ç”¨è¿è¡ŒçŠ¶æ€
pm2 status

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
pm2 logs back-master

# æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼ˆæœ€æ–° 100 è¡Œï¼‰
pm2 logs back-master --lines 100
```

## ğŸ”§ æ‰‹åŠ¨éƒ¨ç½²

å¦‚æœéœ€è¦æ‰‹åŠ¨è§¦å‘éƒ¨ç½²ï¼Œå¯ä»¥åœ¨ GitHub é¡µé¢ï¼š
1. è¿›å…¥ **Actions** æ ‡ç­¾
2. é€‰æ‹© **Deploy to Server** å·¥ä½œæµ
3. ç‚¹å‡» **Run workflow**

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“é…ç½®

ç¡®ä¿æœåŠ¡å™¨ä¸Šçš„ `.env` æ–‡ä»¶å·²æ­£ç¡®é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€‚

### 2. é˜²ç«å¢™è®¾ç½®

ç¡®ä¿æœåŠ¡å™¨é˜²ç«å¢™å…è®¸ï¼š
- SSH è¿æ¥ï¼ˆé»˜è®¤ 22 ç«¯å£ï¼‰
- åº”ç”¨ç«¯å£ï¼ˆé»˜è®¤ 3007ï¼‰

```bash
# ç¤ºä¾‹ï¼šå¼€æ”¾ 3007 ç«¯å£
sudo ufw allow 3007
```

### 3. Nginx åå‘ä»£ç†ï¼ˆæ¨èï¼‰

å¦‚æœéœ€è¦ä½¿ç”¨åŸŸåå’Œ HTTPSï¼Œå»ºè®®é…ç½® Nginxï¼š

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:3007;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 4. æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹ PM2 æ—¥å¿—
pm2 logs back-master

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/out.log
tail -f logs/error.log
```

## ğŸ” æ•…éšœæ’æŸ¥

### éƒ¨ç½²å¤±è´¥

1. æ£€æŸ¥ GitHub Actions æ—¥å¿—
2. ç¡®è®¤ Secrets é…ç½®æ­£ç¡®
3. æ£€æŸ¥æœåŠ¡å™¨ SSH è¿æ¥æ˜¯å¦æ­£å¸¸

### åº”ç”¨å¯åŠ¨å¤±è´¥

1. æ£€æŸ¥ `.env` é…ç½®
2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
3. æŸ¥çœ‹ PM2 æ—¥å¿—ï¼š`pm2 logs`

### ç«¯å£å ç”¨

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
sudo lsof -i :3007

# æ€æ­»è¿›ç¨‹
sudo kill -9 <PID>
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PM2 æ–‡æ¡£](https://pm2.keymetrics.io/docs/usage/quick-start/)
- [GitHub Actions æ–‡æ¡£](https://docs.github.com/cn/actions)
